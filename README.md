# WACK Preview

**WACK Preview** is a WordPress plugin helps you to implement unpublished drafts
previewing system on your frontend.

## How it works

It is created with the intention of being used with the WACK Stack, but it can
also be used with other decoupled headless WordPress systems that have separate
frontend applications (such as REST API, WPGraphQL, etc.).

This plugin replaces the permalinks and preview links of posts (or other custom
post types) that WordPress configures by default.

The link for previews is set with a JWT token as a parameter. Therefore, by
verifying this JWT using the same secret on your frontend application, you can
confirm with certainty that it is a legitimate token generated by WordPress.
This enables you to safely retrieve data before it is published.

## Installation

- Requires PHP 8.1 or later
- Requires WordPress 6.7 or later
- Requires Composer

### Using Composer

```bash
composer require kodansha/wack-preview
```

> [!NOTE]
> This plugin is not available on the WordPress.org plugin repository.
> For the moment, the only way to install it is to use Composer.

## Configuration

To use WACK Preview, it is necessary to configure the mapping of URLs when
actually displaying pages on the frontend.

In addition, it is necessary to configure a token to be included in the secret
URL for the preview.

There are two methods for setting these up:

- Setting through the `WACK_PREVIEW_SETTINGS` constant
- Setting via the settings screen in the WordPress admin menu

### Setting via WACK_PREVIEW_SETTINGS constant

Define `WACK_PREVIEW_SETTINGS` in functions.php or similar:

```php
define('WACK_PREVIEW_SETTINGS', [
    // URL of frontend
    'frontend_base_url' => 'https://frontend.example.com',
    // Preview token settings
    'preview_token' => [
        // Secret key for Token generation
        'secret_key' => 'THIS_IS_A_SECRET_KEY',
        // Expiry time of token (seconds)
        'expiry_time' => 60 * 60 * 24
    ],
    // Path mappings for publish and preview links
    // %id% will be replaced with the actual post id when generating links
    // e.g. /post/%id% -> /post/123
    // The generated links will replace the original links
    'path_mappings' => [
        // Mapping for each post types
        // This example is for the default "post" type
        'post' => [
            'publish' => '/posts/%id%',
            'preview' => '/posts/preview/%id%'
        ],
        // Another custom post type you would like to rewrite permalinks
        'news' => [
            'publish' => '/news/%slug%',
            // You can set a preview path including query string
            // query strings will be merged with "preview_token" and "preview"
            'preview' => '/news/preview?slug=%slug%'
        ],
    ],
]);
```

> [!NOTE]
> In multisite WordPress installations, the `WACK_PREVIEW_SETTINGS` does not
> work as expected. Please configure settings for each site from the admin menu
> when using multisite.

### Setting via WordPress admin menu

Go to the settings screen of WACK Preview in the WordPress admin menu and
follow the instructions on the screen.

> [!TIP]
> If settings exist both in `WACK_PREVIEW_SETTINGS` and the settings screen
> at the same time, the settings defined in the constant are prioritized as
> a general rule. Therefore, you can configure flexibly, such as setting only
> the `secret_key` as a constant that you don't want to store in the database,
> while managing other settings through the admin screen.
